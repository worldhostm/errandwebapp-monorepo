# ì‹¬ë¶€ë¦„ ì¡°íšŒ ë¡œì§ ë¶„ì„ ë¬¸ì„œ

## ê°œìš”
í˜„ì¬ ì‹¬ë¶€ë¦„ ì›¹ì•±ì—ì„œ ì§€ë„ì— í‘œì‹œë˜ëŠ” ì‹¬ë¶€ë¦„ê³¼ ëª©ë¡ì— í‘œì‹œë˜ëŠ” ì‹¬ë¶€ë¦„ì˜ ì¡°íšŒ ê¸°ì¤€ê³¼ ë¡œì§ì— ëŒ€í•œ ë¶„ì„ ë¬¸ì„œì…ë‹ˆë‹¤.

## 1. ì§€ë„ì— í‘œì‹œë˜ëŠ” ì‹¬ë¶€ë¦„ ì¡°íšŒ ë¡œì§

### API ì—”ë“œí¬ì¸íŠ¸
- **URL**: `/api/errands/nearby`
- **ë©”ì„œë“œ**: GET
- **ì»¨íŠ¸ë¡¤ëŸ¬**: `errandController.ts:getNearbyErrands` (33-85í–‰)

### ì¡°íšŒ ê¸°ì¤€
1. **ì§€ë¦¬ì  ìœ„ì¹˜ ê¸°ë°˜ ì¡°íšŒ**
   - MongoDBì˜ `$near` ì—°ì‚°ì ì‚¬ìš©
   - ì§€ë„ ì¤‘ì‹¬ì  ê¸°ì¤€ìœ¼ë¡œ ë°˜ê²½ ë‚´ ì¡°íšŒ
   - ê¸°ë³¸ ë°˜ê²½: 5km (5000m)
   - í™•ì¥ ë°˜ê²½: 50km (50000m)

2. **í•„í„°ë§ ì¡°ê±´**
   ```typescript
   const query: any = {
     status: 'pending',  // ëŒ€ê¸°ì¤‘ì¸ ì‹¬ë¶€ë¦„ë§Œ
     location: {
       $near: {
         $geometry: {
           type: 'Point',
           coordinates: [longitude, latitude]
         },
         $maxDistance: radiusInMeters
       }
     }
   };
   
   // ìì‹ ì˜ ì‹¬ë¶€ë¦„ ì œì™¸ (ë¡œê·¸ì¸í•œ ê²½ìš°)
   if (user) {
     query.requestedBy = { $ne: user._id };
   }
   ```

3. **ì •ë ¬ ë° ì œí•œ**
   - `createdAt: -1` (ìµœì‹ ìˆœ)
   - í˜ì´ì§€ë„¤ì´ì…˜ ì§€ì› (ê¸°ë³¸ 20ê°œ ì œí•œ)

### í”„ë¡ íŠ¸ì—”ë“œ í˜¸ì¶œ ì‹œì 
- **ì§€ë„ ì´ë™ ì‹œ**: `Map.tsx:debouncedOnMapMove` (129-171í–‰)
- **ì‚¬ìš©ì ìœ„ì¹˜ ë³€ê²½ ì‹œ**: `page.tsx:fetchErrandsAtLocation` (132-189í–‰)
- **ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ**: ì§€ë„ ì´ë™ê³¼ ë™ì¼í•œ ë¡œì§ ì ìš©

### ë””ë°”ìš´ì‹± ë° ìµœì í™”
- **0.8ì´ˆ ë””ë°”ìš´ìŠ¤**: ì§€ë„ ë“œë˜ê·¸ ì¤‘ ê³¼ë„í•œ API í˜¸ì¶œ ë°©ì§€
- **ìµœì†Œ ì´ë™ ê±°ë¦¬**: 200m ë¯¸ë§Œ ì´ë™ ì‹œ ì¬ì¡°íšŒ ìƒëµ
- **AbortController**: ì´ì „ ìš”ì²­ ì·¨ì†Œë¡œ ì¤‘ë³µ ìš”ì²­ ë°©ì§€

## 2. ëª©ë¡ì— í‘œì‹œë˜ëŠ” ì‹¬ë¶€ë¦„ ì¡°íšŒ ë¡œì§

### 2-1. ë©”ì¸ í˜ì´ì§€ ì‹¬ë¶€ë¦„ ëª©ë¡ (receiver íƒ­)

#### ì¡°íšŒ ë¡œì§
- **ë™ì¼í•œ API ì‚¬ìš©**: `/api/errands/nearby`
- **ì§€ë„ì™€ ë™ì¼í•œ ì¡°ê±´**: ìœ„ì¹˜ ê¸°ë°˜ + ìƒíƒœ í•„í„°ë§

#### í•„í„°ë§ ì¶”ê°€ ë¡œì§ (`page.tsx:fetchErrandsAtLocation`)
```typescript
// í˜„ì¬ ì§€ë„ boundsê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë²”ìœ„ ë‚´ì˜ ì‹¬ë¶€ë¦„ë§Œ í‘œì‹œ
let finalErrands = processed
if (currentMapBounds) {
  finalErrands = processed.filter(errand => {
    return errand.lat >= currentMapBounds.sw.lat && errand.lat <= currentMapBounds.ne.lat &&
           errand.lng >= currentMapBounds.sw.lng && errand.lng <= currentMapBounds.ne.lng
  })
}
```

#### í‘œì‹œë˜ëŠ” ì‹¬ë¶€ë¦„
- ì§€ë„ í™”ë©´ ë²”ìœ„ ë‚´ì— ìˆëŠ” ì‹¬ë¶€ë¦„ë§Œ ëª©ë¡ì— í‘œì‹œ
- ê±°ë¦¬ìˆœ ì •ë ¬ (`processErrands`ì—ì„œ ì²˜ë¦¬)

### 2-2. ë‚´ê°€ ìˆ˜í–‰í•˜ëŠ” ì‹¬ë¶€ë¦„ (performer íƒ­)

#### API ì—”ë“œí¬ì¸íŠ¸
- **URL**: `/api/errands/user?type=accepted`
- **ì»¨íŠ¸ë¡¤ëŸ¬**: `errandController.ts:getUserErrands` (195-246í–‰)

#### ì¡°íšŒ ê¸°ì¤€
```typescript
const query: any = {
  acceptedBy: user._id,  // ë‚´ê°€ ìˆ˜ë½í•œ ì‹¬ë¶€ë¦„
  // status í•„í„°ë§ì€ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì²˜ë¦¬
};
```

#### í•„í„°ë§
- **ìƒíƒœë³„ í•„í„°**: all, accepted, in_progress, completed
- **ìœ„ì¹˜ ë¬´ê´€**: ì§€ë¦¬ì  ìœ„ì¹˜ì™€ ìƒê´€ì—†ì´ ë‚´ê°€ ìˆ˜ë½í•œ ëª¨ë“  ì‹¬ë¶€ë¦„

### 2-3. ë‚´ê°€ ë“±ë¡í•œ ì‹¬ë¶€ë¦„ (requester íƒ­)

#### API ì—”ë“œí¬ì¸íŠ¸
- **URL**: `/api/errands/user?type=requested`
- **ì»¨íŠ¸ë¡¤ëŸ¬**: ë™ì¼í•œ `getUserErrands` í•¨ìˆ˜

#### ì¡°íšŒ ê¸°ì¤€
```typescript
const query: any = {
  requestedBy: user._id,  // ë‚´ê°€ ë“±ë¡í•œ ì‹¬ë¶€ë¦„
};
```

## 3. ì§€ë„ì™€ ëª©ë¡ ê°„ì˜ ì°¨ì´ì  ë¶„ì„

### í˜„ì¬ ìƒí™©
1. **ì§€ë„ í‘œì‹œ ì‹¬ë¶€ë¦„**: ì§€ë„ bounds ë‚´ + ìœ„ì¹˜ ê¸°ë°˜ ì¡°íšŒ ê²°ê³¼
2. **ëª©ë¡ í‘œì‹œ ì‹¬ë¶€ë¦„**: ë™ì¼í•œ ë°ì´í„°ì—ì„œ bounds í•„í„°ë§ ì ìš©

### ë¬¸ì œì 
- **ë™ê¸°í™”ë¨**: ì§€ë„ì™€ ëª©ë¡ì´ ê°™ì€ API í˜¸ì¶œ ê²°ê³¼ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì¼ì¹˜í•¨
- **bounds í•„í„°ë§**: ì§€ë„ í™”ë©´ ë°– ì‹¬ë¶€ë¦„ì€ ëª©ë¡ì—ì„œë„ ì œì™¸ë¨

## 4. í•´ê²° ë°©ì•ˆ: ì§€ë„ ë°– ì‹¬ë¶€ë¦„ì„ ëª©ë¡ì—ì„œ ìˆ¨ê¸°ê¸°

### í˜„ì¬ ë¡œì§ì˜ ë³€ê²½ì 
`page.tsx:fetchErrandsAtLocation` í•¨ìˆ˜ì—ì„œ ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

```typescript
// 164-171í–‰: bounds í•„í„°ë§
if (currentMapBounds) {
  finalErrands = processed.filter(errand => {
    return errand.lat >= currentMapBounds.sw.lat && errand.lat <= currentMapBounds.ne.lat &&
           errand.lng >= currentMapBounds.sw.lng && errand.lng <= currentMapBounds.ne.lng
  })
  console.log(`ğŸ“ bounds í•„í„°ë§ (fetchErrandsAtLocation): ${processed.length}ê°œ â†’ ${finalErrands.length}ê°œ`)
}
```

### ì¶”ê°€ ìµœì í™” ë°©ì•ˆ
1. **API ë ˆë²¨ì—ì„œ bounds í•„í„°ë§**: 
   - í´ë¼ì´ì–¸íŠ¸ì—ì„œ bounds ì •ë³´ë¥¼ APIë¡œ ì „ë‹¬
   - ì„œë²„ì—ì„œ ì§ì ‘ bounds ë‚´ ì‹¬ë¶€ë¦„ë§Œ ì¡°íšŒ
   - ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê°ì†Œ

2. **ìºì‹± ì „ëµ**:
   - ì§€ì—­ë³„ ì‹¬ë¶€ë¦„ ë°ì´í„° ìºì‹±
   - ì§€ë„ ì´ë™ ì‹œ ìºì‹œëœ ë°ì´í„° í™œìš©

## 5. ì½”ë“œ ìœ„ì¹˜ ì°¸ì¡°

### Backend
- **ë¼ìš°í„°**: `apps/backend/src/routes/errands.ts:20` - GET /nearby
- **ì»¨íŠ¸ë¡¤ëŸ¬**: `apps/backend/src/controllers/errandController.ts:33-85` - getNearbyErrands
- **ì‚¬ìš©ì ì‹¬ë¶€ë¦„**: `apps/backend/src/controllers/errandController.ts:195-246` - getUserErrands

### Frontend
- **ë©”ì¸ í˜ì´ì§€**: `apps/frontend/app/page.tsx:132-189` - fetchErrandsAtLocation
- **ì§€ë„ ì»´í¬ë„ŒíŠ¸**: `apps/frontend/app/components/Map.tsx:129-171` - debouncedOnMapMove
- **API í´ë¼ì´ì–¸íŠ¸**: `apps/frontend/app/lib/api.ts:83-94` - getNearbyErrands
- **ìˆ˜í–‰ ì‹¬ë¶€ë¦„**: `apps/frontend/app/components/MyAcceptedErrands.tsx:60-84` - fetchMyAcceptedErrands

## 6. ìš”ì•½

**í˜„ì¬ ìƒíƒœ**: ì§€ë„ ë°– ì‹¬ë¶€ë¦„ì€ ì´ë¯¸ ëª©ë¡ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
- ì§€ë„ì™€ ëª©ë¡ì´ ë™ì¼í•œ ë°ì´í„°ì…‹ ì‚¬ìš©
- ì§€ë„ bounds ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ ì ìš©
- ì‚¬ìš©ìê°€ ì§€ë„ë¥¼ ì´ë™í•˜ë©´ í•´ë‹¹ ì§€ì—­ ì‹¬ë¶€ë¦„ë§Œ ëª©ë¡ì— í‘œì‹œ

**ê°œì„  ì œì•ˆ**: í˜„ì¬ ë¡œì§ì´ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ë¯€ë¡œ ì¶”ê°€ ë³€ê²½ì´ ë¶ˆí•„ìš”í•˜ë‚˜, ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì„œë²„ ë ˆë²¨ bounds í•„í„°ë§ ê³ ë ¤ ê°€ëŠ¥í•©ë‹ˆë‹¤.